<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"zhengbomo.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="SQLAlchemy是python的一个数据库ORM工具，提供了强大的对象模型间的转换，可以满足绝大多数数据库操作的需求，并且支持多种数据库引擎（sqlite，mysql，postgres, mongodb等），在这里记录基本用法和学习笔记">
<meta property="og:type" content="article">
<meta property="og:title" content="sqlalchemy学习笔记">
<meta property="og:url" content="http://zhengbomo.github.io/2016-09-11/sqlalchemy-start/index.html">
<meta property="og:site_name" content="bomo的开发随笔">
<meta property="og:description" content="SQLAlchemy是python的一个数据库ORM工具，提供了强大的对象模型间的转换，可以满足绝大多数数据库操作的需求，并且支持多种数据库引擎（sqlite，mysql，postgres, mongodb等），在这里记录基本用法和学习笔记">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2016-09-11T04:17:15.000Z">
<meta property="article:modified_time" content="2016-09-11T04:17:15.000Z">
<meta property="article:author" content="bomo">
<meta property="article:tag" content="sql">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://zhengbomo.github.io/2016-09-11/sqlalchemy-start/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>sqlalchemy学习笔记 | bomo的开发随笔</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="bomo的开发随笔" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">bomo的开发随笔</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">记录工作学习点滴</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-exclamation-circle fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">45</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">13</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">99</span></a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://zhengbomo.github.io/2016-09-11/sqlalchemy-start/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Author">
      <meta itemprop="description" content="懒人">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="bomo的开发随笔">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          sqlalchemy学习笔记
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-09-11 12:17:15" itemprop="dateCreated datePublished" datetime="2016-09-11T12:17:15+08:00">2016-09-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p><a target="_blank" rel="noopener" href="http://www.sqlalchemy.org/">SQLAlchemy</a>是python的一个数据库ORM工具，提供了强大的对象模型间的转换，可以满足绝大多数数据库操作的需求，并且支持多种数据库引擎（sqlite，mysql，postgres, mongodb等），在这里记录基本用法和学习笔记</p>
<span id="more"></span>

<h2 id="一、安装"><a href="#一、安装" class="headerlink" title="一、安装"></a>一、安装</h2><p>通过pip安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ pip install SQLAlchemy</span><br></pre></td></tr></table></figure>

<h2 id="二、使用"><a href="#二、使用" class="headerlink" title="二、使用"></a>二、使用</h2><p>首先是连接到数据库，SQLALchemy支持多个数据库引擎，不同的数据库引擎连接字符串不一样，常用的有</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql://username:password@hostname/database</span><br><span class="line">postgresql://username:password@hostname/database</span><br><span class="line">sqlite:////absolute/path/to/database</span><br><span class="line">sqlite:///c:/absolute/path/to/database</span><br></pre></td></tr></table></figure>

<p>更多连接字符串的介绍参见<a target="_blank" rel="noopener" href="http://docs.sqlalchemy.org/en/latest/core/engines.html?highlight=create_engine#database-urls">这里</a></p>
<p>下面是连接和使用sqlite数据库的例子</p>
<h3 id="1-connection"><a href="#1-connection" class="headerlink" title="1. connection"></a>1. connection</h3><p>使用传统的connection的方式连接和操作数据库</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine</span><br><span class="line"></span><br><span class="line"><span class="comment"># 数据库连接字符串</span></span><br><span class="line">DB_CONNECT_STRING = <span class="string">&#x27;sqlite:///:memory:&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建数据库引擎,echo为True,会打印所有的sql语句</span></span><br><span class="line">engine = create_engine(DB_CONNECT_STRING, echo=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个connection，这里的使用方式与python自带的sqlite的使用方式类似</span></span><br><span class="line"><span class="keyword">with</span> engine.connect() <span class="keyword">as</span> con:</span><br><span class="line">    <span class="comment"># 执行sql语句，如果是增删改，则直接生效，不需要commit</span></span><br><span class="line">    rs = con.execute(<span class="string">&#x27;SELECT 5&#x27;</span>)</span><br><span class="line">    data = rs.fetchone()[<span class="number">0</span>]</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;Data: %s&quot;</span> % data</span><br></pre></td></tr></table></figure>
<p>与python自带的sqlite不同，这里不需要Cursor光标，执行sql语句不需要commit</p>
<h3 id="2-connection事务"><a href="#2-connection事务" class="headerlink" title="2. connection事务"></a>2. connection事务</h3><p>使用事务可以进行批量提交和回滚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine</span><br><span class="line"></span><br><span class="line"><span class="comment"># 数据库连接字符串</span></span><br><span class="line">DB_CONNECT_STRING = <span class="string">&#x27;sqlite:////Users/zhengxiankai/Desktop/Document/db.sqlite&#x27;</span></span><br><span class="line">engine = create_engine(DB_CONNECT_STRING, echo=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> engine.connect() <span class="keyword">as</span> connection:</span><br><span class="line">    trans = connection.begin()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        r1 = connection.execute(<span class="string">&quot;select * from User&quot;</span>)</span><br><span class="line">        r2 = connection.execute(<span class="string">&quot;insert into User(name, age) values(?, ?)&quot;</span>, <span class="string">&#x27;bomo&#x27;</span>, <span class="number">24</span>)</span><br><span class="line">        trans.commit()</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        trans.rollback()</span><br><span class="line">        <span class="keyword">raise</span></span><br></pre></td></tr></table></figure>

<h3 id="3-session"><a href="#3-session" class="headerlink" title="3. session"></a>3. session</h3><p>connection是一般使用数据库的方式，sqlalchemy还提供了另一种操作数据库的方式，通过session对象，session可以记录和跟踪数据的改变，在适当的时候提交，并且支持强大的ORM的功能，下面是基本使用</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> sessionmaker</span><br><span class="line"></span><br><span class="line"><span class="comment"># 数据库连接字符串</span></span><br><span class="line">DB_CONNECT_STRING = <span class="string">&#x27;sqlite:////Users/zhengxiankai/Desktop/Document/db.sqlite&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建数据库引擎,echo为True,会打印所有的sql语句</span></span><br><span class="line">engine = create_engine(DB_CONNECT_STRING, echo=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建会话类</span></span><br><span class="line">DB_Session = sessionmaker(bind=engine)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建会话对象</span></span><br><span class="line">session = DB_Session()</span><br><span class="line"></span><br><span class="line"><span class="comment"># dosomething with session</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 用完记得关闭，也可以用with</span></span><br><span class="line">session.close()</span><br></pre></td></tr></table></figure>

<p>上面创建了一个session对象，接下来可以操作数据库了，session也支持通过sql语句操作数据库</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">session.execute(<span class="string">&#x27;select * from User&#x27;</span>)</span><br><span class="line">session.execute(<span class="string">&quot;insert into User(name, age) values(&#x27;bomo&#x27;, 13)&quot;</span>)</span><br><span class="line">session.execute(<span class="string">&quot;insert into User(name, age) values(:name, :age)&quot;</span>, &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;bomo&#x27;</span>, <span class="string">&#x27;age&#x27;</span>:<span class="number">12</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果是增删改，需要commit</span></span><br><span class="line">session.commit()</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意参数使用dict，并在sql语句中使用<code>:key</code>占位</p>
</blockquote>
<h3 id="4-ORM"><a href="#4-ORM" class="headerlink" title="4. ORM"></a>4. ORM</h3><p>上面简单介绍了sql的简单用法，既然是ORM框架，我们先定义两个模型类<code>User</code>和<code>Role</code>，sqlalchemy的模型类继承自一个由<code>declarative_base()</code>方法生成的类，我们先定义一个模块<code>Models.py</code>生成Base类</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy.ext.declarative <span class="keyword">import</span> declarative_base</span><br><span class="line"></span><br><span class="line">Base = declarative_base()</span><br></pre></td></tr></table></figure>

<p><code>User.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> Column, Integer, String</span><br><span class="line"><span class="keyword">from</span> Models <span class="keyword">import</span> Base</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(<span class="title class_ inherited__">Base</span>):</span><br><span class="line">    __tablename__ = <span class="string">&#x27;User&#x27;</span></span><br><span class="line">    <span class="built_in">id</span> = Column(<span class="string">&#x27;id&#x27;</span>, Integer, primary_key=<span class="literal">True</span>, autoincrement=<span class="literal">True</span>)</span><br><span class="line">    name = Column(<span class="string">&#x27;name&#x27;</span>, String(<span class="number">50</span>))</span><br><span class="line">    age = Column(<span class="string">&#x27;age&#x27;</span>, Integer)</span><br></pre></td></tr></table></figure>

<p><code>Role.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> Column, Integer, String</span><br><span class="line"><span class="keyword">from</span> Models <span class="keyword">import</span> Base</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Role</span>(<span class="title class_ inherited__">Base</span>):</span><br><span class="line">    __tablename__ = <span class="string">&#x27;Role&#x27;</span></span><br><span class="line">    <span class="built_in">id</span> = Column(<span class="string">&#x27;id&#x27;</span>, Integer, primary_key=<span class="literal">True</span>, autoincrement=<span class="literal">True</span>)</span><br><span class="line">    name = Column(<span class="string">&#x27;name&#x27;</span>, String(<span class="number">50</span>))</span><br></pre></td></tr></table></figure>

<p>从上面很容易看出来，这里的模型对应数据库中的表，模型支持的类型有<code>Integer</code>, <code>String</code>, <code>Boolean</code>, <code>Date</code>, <code>DateTime</code>, <code>Float</code>，更多类型包括类型对应的Python的类型参见：<a target="_blank" rel="noopener" href="http://docs.sqlalchemy.org/en/latest/core/type_basics.html?highlight=column%20type#generic-types">这里</a></p>
<p>Column构造函数相关设置</p>
<ul>
<li>name：名称</li>
<li>type_：列类型</li>
<li>autoincrement：自增</li>
<li>default：默认值</li>
<li>index：索引</li>
<li>nullable：可空</li>
<li>primary_key：外键</li>
</ul>
<p>更多介绍参见<a target="_blank" rel="noopener" href="http://docs.sqlalchemy.org/en/latest/core/metadata.html?highlight=column%20autoincrement#sqlalchemy.schema.Column.__init__">这里</a></p>
<p>接下来通过session进行增删改查</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> sessionmaker</span><br><span class="line"><span class="keyword">from</span> User <span class="keyword">import</span> User</span><br><span class="line"><span class="keyword">from</span> Role <span class="keyword">import</span> Role</span><br><span class="line"><span class="keyword">from</span> Models <span class="keyword">import</span> Base</span><br><span class="line"></span><br><span class="line">DB_CONNECT_STRING = <span class="string">&#x27;sqlite:////Users/zhengxiankai/Desktop/Document/db.sqlite&#x27;</span></span><br><span class="line">engine = create_engine(DB_CONNECT_STRING, echo=<span class="literal">True</span>)</span><br><span class="line">DB_Session = sessionmaker(bind=engine)</span><br><span class="line">session = DB_Session()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. 创建表（如果表已经存在，则不会创建）</span></span><br><span class="line">Base.metadata.create_all(engine)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 插入数据</span></span><br><span class="line">u = User(name = <span class="string">&#x27;tobi&#x27;</span>, age = <span class="number">200</span>)</span><br><span class="line">r = Role(name = <span class="string">&#x27;user&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.1 使用add，如果已经存在，会报错</span></span><br><span class="line">session.add(u)</span><br><span class="line">session.add(r)</span><br><span class="line">session.commit()</span><br><span class="line"><span class="built_in">print</span> r.<span class="built_in">id</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3 修改数据</span></span><br><span class="line"><span class="comment"># 3.1 使用merge方法，如果存在则修改，如果不存在则插入（只判断主键，不判断unique列）</span></span><br><span class="line">r.name = <span class="string">&#x27;admin&#x27;</span></span><br><span class="line">session.merge(r)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.2 也可以通过这种方式修改</span></span><br><span class="line">session.query(Role).<span class="built_in">filter</span>(Role.<span class="built_in">id</span> == <span class="number">1</span>).update(&#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;admin&#x27;</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 删除数据</span></span><br><span class="line">session.query(Role).<span class="built_in">filter</span>(Role.<span class="built_in">id</span> == <span class="number">1</span>).delete()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 查询数据</span></span><br><span class="line"><span class="comment"># 5.1 返回结果集的第二项</span></span><br><span class="line">user = session.query(User).get(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5.2 返回结果集中的第2-3项</span></span><br><span class="line">users = session.query(User)[<span class="number">1</span>:<span class="number">3</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5.3 查询条件</span></span><br><span class="line">user = session.query(User).<span class="built_in">filter</span>(User.<span class="built_in">id</span> &lt; <span class="number">6</span>).first()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5.4 排序</span></span><br><span class="line">users = session.query(User).order_by(User.name)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5.5 降序（需要导入desc方法）</span></span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> desc</span><br><span class="line">users = session.query(User).order_by(desc(User.name))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5.6 只查询部分属性</span></span><br><span class="line">users = session.query(User.name).order_by(desc(User.name))</span><br><span class="line"><span class="keyword">for</span> user <span class="keyword">in</span> users:</span><br><span class="line">    <span class="built_in">print</span> user.name</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5.7 给结果集的列取别名</span></span><br><span class="line">users = session.query(User.name.label(<span class="string">&#x27;user_name&#x27;</span>)).<span class="built_in">all</span>()</span><br><span class="line"><span class="keyword">for</span> user <span class="keyword">in</span> users:</span><br><span class="line">    <span class="built_in">print</span> user.user_name</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5.8 去重查询（需要导入distinct方法）</span></span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> distinct</span><br><span class="line">users = session.query(distinct(User.name).label(<span class="string">&#x27;name&#x27;</span>)).<span class="built_in">all</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5.9 统计查询</span></span><br><span class="line">user_count = session.query(User.name).order_by(User.name).count()</span><br><span class="line">age_avg = session.query(func.avg(User.age)).first()</span><br><span class="line">age_sum = session.query(func.<span class="built_in">sum</span>(User.age)).first()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5.10 分组查询</span></span><br><span class="line">users = session.query(func.count(User.name).label(<span class="string">&#x27;count&#x27;</span>), User.age).group_by(User.age)</span><br><span class="line"><span class="keyword">for</span> user <span class="keyword">in</span> users:</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&#x27;age:&#123;0&#125;, count:&#123;1&#125;&#x27;</span>.<span class="built_in">format</span>(user.age, user.count)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 6.1 exists查询(不存在则为~exists())</span></span><br><span class="line"><span class="keyword">from</span> sqlalchemy.sql <span class="keyword">import</span> exists</span><br><span class="line">session.query(User.name).<span class="built_in">filter</span>(~exists().where(User.role_id == Role.<span class="built_in">id</span>))</span><br><span class="line"><span class="comment"># SELECT name AS users_name FROM users WHERE NOT EXISTS (SELECT * FROM roles WHERE users.role_id = roles.id)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 6.2 除了exists，any也可以表示EXISTS</span></span><br><span class="line">session.query(Role).<span class="built_in">filter</span>(Role.users.<span class="built_in">any</span>())</span><br><span class="line"></span><br><span class="line"><span class="comment"># 7 random</span></span><br><span class="line"><span class="keyword">from</span> sqlalchemy.sql.functions <span class="keyword">import</span> random</span><br><span class="line">user = session.query(User).order_by(random()).first()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">session.close()</span><br></pre></td></tr></table></figure>
<p>参考链接：</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://docs.sqlalchemy.org/en/latest/orm/internals.html?highlight=any#sqlalchemy.orm.properties.RelationshipProperty.Comparator.any">any</a></li>
</ul>
<h3 id="5-多表关系"><a href="#5-多表关系" class="headerlink" title="5. 多表关系"></a>5. 多表关系</h3><p>上面的所有操作都是基于单个表的操作，下面是多表以及关系的使用，我们修改上面两个表，添加外键关联（一对多和多对一）</p>
<p>User模型</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> Column, Integer, String</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> ForeignKey</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> relationship</span><br><span class="line"><span class="keyword">from</span> Models <span class="keyword">import</span> Base</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(<span class="title class_ inherited__">Base</span>):</span><br><span class="line">    __tablename__ = <span class="string">&#x27;users&#x27;</span></span><br><span class="line">    <span class="built_in">id</span> = Column(<span class="string">&#x27;id&#x27;</span>, Integer, primary_key=<span class="literal">True</span>, autoincrement=<span class="literal">True</span>)</span><br><span class="line">    name = Column(<span class="string">&#x27;name&#x27;</span>, String(<span class="number">50</span>))</span><br><span class="line">    age = Column(<span class="string">&#x27;age&#x27;</span>, Integer)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 添加角色id外键(关联到Role表的id属性)</span></span><br><span class="line">    role_id = Column(<span class="string">&#x27;role_id&#x27;</span>, Integer, ForeignKey(<span class="string">&#x27;roles.id&#x27;</span>))</span><br><span class="line">    <span class="comment"># 添加同表外键</span></span><br><span class="line">    second_role_id = Column(<span class="string">&#x27;second_role_id&#x27;</span>, Integer, ForeignKey(<span class="string">&#x27;roles.id&#x27;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 添加关系属性，关联到role_id外键上</span></span><br><span class="line">    role = relationship(<span class="string">&#x27;Role&#x27;</span>, foreign_keys=<span class="string">&#x27;User.role_id&#x27;</span>, backref=<span class="string">&#x27;User_role_id&#x27;</span>)</span><br><span class="line">    <span class="comment"># 添加关系属性，关联到second_role_id外键上</span></span><br><span class="line">    second_role = relationship(<span class="string">&#x27;Role&#x27;</span>, foreign_keys=<span class="string">&#x27;User.second_role_id&#x27;</span>, backref=<span class="string">&#x27;User_second_role_id&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>Role模型</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> Column, Integer, String</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> relationship</span><br><span class="line"><span class="keyword">from</span> Models <span class="keyword">import</span> Base</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Role</span>(<span class="title class_ inherited__">Base</span>):</span><br><span class="line">    __tablename__ = <span class="string">&#x27;roles&#x27;</span></span><br><span class="line">    <span class="built_in">id</span> = Column(<span class="string">&#x27;id&#x27;</span>, Integer, primary_key=<span class="literal">True</span>, autoincrement=<span class="literal">True</span>)</span><br><span class="line">    name = Column(<span class="string">&#x27;name&#x27;</span>, String(<span class="number">50</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 添加关系属性，关联到User.role_id属性上</span></span><br><span class="line">    users = relationship(<span class="string">&quot;User&quot;</span>, foreign_keys=<span class="string">&#x27;User.role_id&#x27;</span>, backref=<span class="string">&quot;Role_users&quot;</span>)</span><br><span class="line">    <span class="comment"># 添加关系属性，关联到User.second_role_id属性上</span></span><br><span class="line">    second_users = relationship(<span class="string">&quot;User&quot;</span>, foreign_keys=<span class="string">&#x27;User.second_role_id&#x27;</span>, backref=<span class="string">&quot;Role_second_users&quot;</span>)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这里有一点需要注意的是，设置外键的时候<code>ForeignKey(&#39;roles.id&#39;)</code>这里面使用的是表名和表列，在设置关联属性的时候<code>relationship(&#39;Role&#39;, foreign_keys=&#39;User.role_id&#39;, backref=&#39;User_role_id&#39;)</code>，这里的<code>foreign_keys</code>使用的时候类名和属性名</p>
</blockquote>
<p>接下来就可以使用了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">u = User(name=<span class="string">&#x27;tobi&#x27;</span>, age=<span class="number">200</span>)</span><br><span class="line"></span><br><span class="line">r1 = Role(name=<span class="string">&#x27;admin&#x27;</span>)</span><br><span class="line">r2 = Role(name=<span class="string">&#x27;user&#x27;</span>)</span><br><span class="line"></span><br><span class="line">u.role = r1</span><br><span class="line">u.second_role = r2</span><br><span class="line"></span><br><span class="line">session.add(u)</span><br><span class="line">session.commit()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询（对于外键关联的关系属性可以直接访问，在需要用到的时候session会到数据库查询）</span></span><br><span class="line">roles = session.query(Role).<span class="built_in">all</span>()</span><br><span class="line"><span class="keyword">for</span> role <span class="keyword">in</span> roles:</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&#x27;role:&#123;0&#125; users&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> user <span class="keyword">in</span> role.users:</span><br><span class="line">        <span class="built_in">print</span> <span class="string">&#x27;\t&#123;0&#125;&#x27;</span>.<span class="built_in">format</span>(user.name)</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&#x27;role:&#123;0&#125; second_users&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> user <span class="keyword">in</span> role.second_users:</span><br><span class="line">        <span class="built_in">print</span> <span class="string">&#x27;\t&#123;0&#125;&#x27;</span>.<span class="built_in">format</span>(user.name)</span><br></pre></td></tr></table></figure>


<p>上面表示的是一对多（多对一）的关系，还有一对一，多对多，如果要表示一对一的关系，在定义relationship的时候设置<code>uselist</code>为False（默认为True），如在Role中</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Role</span>(<span class="title class_ inherited__">Base</span>):</span><br><span class="line">    ...</span><br><span class="line">    user = relationship(<span class="string">&quot;User&quot;</span>, uselist=<span class="literal">False</span>, foreign_keys=<span class="string">&#x27;User.role_id&#x27;</span>, backref=<span class="string">&quot;Role_user&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="6-多表查询"><a href="#6-多表查询" class="headerlink" title="6. 多表查询"></a>6. 多表查询</h3><p>多表查询通常使用<code>join</code>进行表连接，第一个参数为表名，第二个参数为条件，例如</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">users = db.session.query(User).join(Role, Role.<span class="built_in">id</span> == User.role_id)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> u <span class="keyword">in</span> users:</span><br><span class="line">    <span class="built_in">print</span> u.name</span><br></pre></td></tr></table></figure>

<p><code>join</code>为内连接，还有左连接<code>outerjoin</code>，用法与join类似，右连接和全外链接在<code>1.0</code>版本上不支持，通常来说有这两个结合查询的方法基本够用了，<code>1.1</code>版本貌似添加了右连接和全外连接的支持，但是目前只是预览版</p>
<p>还可以直接查询多个表，如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">result = db.session.query(User, Role).<span class="built_in">filter</span>(User.role_id = Role.<span class="built_in">id</span>)</span><br><span class="line"><span class="comment"># 这里选择的是两个表，使用元组获取数据</span></span><br><span class="line"><span class="keyword">for</span> u, r <span class="keyword">in</span> result:</span><br><span class="line">      <span class="built_in">print</span> u.name</span><br></pre></td></tr></table></figure>

<h2 id="三、数据库迁移"><a href="#三、数据库迁移" class="headerlink" title="三、数据库迁移"></a>三、数据库迁移</h2><p>sqlalchemy的数据库迁移&#x2F;升级有两个库支持<a target="_blank" rel="noopener" href="http://alembic.zzzcomputing.com/en/latest/">alembic</a>和<a target="_blank" rel="noopener" href="https://sqlalchemy-migrate.readthedocs.io/en/latest/">sqlalchemy-migrate</a></p>
<p>由于sqlalchemy-migrate在2011年发布了0.7.2版本后，就已经停止更新了，并且已经不维护了，也积累了很多bug，而alembic是较后来才出现，而且是sqlalchemy的作者开发的，有良好的社区支持，所以在这里只学习alembic这个库</p>
<p>alembic实现了类似git&#x2F;svn的版本管理的控制，我们可以通过alembic维护每次升级数据库的版本</p>
<h3 id="1-安装"><a href="#1-安装" class="headerlink" title="1. 安装"></a>1. 安装</h3><p>通过<code>pip</code>安装，pip会自动安装相关的依赖</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ pip install alembic</span><br></pre></td></tr></table></figure>

<h3 id="2-初始化"><a href="#2-初始化" class="headerlink" title="2. 初始化"></a>2. 初始化</h3><p>安装完成后再项目根目录运行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ alembic init YOUR_ALEMBIC_DIR</span><br></pre></td></tr></table></figure>
<p>alembic会在根目录创建<code>YOUR_ALEMBIC_DIR</code>目录和<code>alembic.ini</code>文件，如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">yourproject/</span><br><span class="line">    alembic.ini</span><br><span class="line">    YOUR_ALEMBIC_DIR/</span><br><span class="line">        env.py</span><br><span class="line">        README</span><br><span class="line">        script.py.mako</span><br><span class="line">        versions/</span><br><span class="line">            3512b954651e_add_account.py</span><br><span class="line">            2b1ae634e5cd_add_order_id.py</span><br><span class="line">            3adcc9a56557_rename_username_field.py</span><br></pre></td></tr></table></figure>
<p>其中</p>
<ul>
<li><code>alembic.ini</code> 提供了一些基本的配置</li>
<li><code>env.py</code> 每次执行Alembic都会加载这个模块，主要提供项目Sqlalchemy Model 的连接</li>
<li><code>script.py.mako</code> 迁移脚本生成模版</li>
<li><code>versions</code> 存放生成的迁移脚本目录</li>
</ul>
<p>默认情况下创建的是基于单个数据库的，如果需要支持多个数据库或其他，可以通过<code>alembic list_templates</code>查看支持的模板</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ alembic list_templates</span><br><span class="line">Available templates:</span><br><span class="line"></span><br><span class="line">generic - Generic single-database configuration.</span><br><span class="line">multidb - Rudimentary multi-database configuration.</span><br><span class="line">pylons - Configuration that reads from a Pylons project environment.</span><br><span class="line"></span><br><span class="line">Templates are used via the <span class="string">&#x27;init&#x27;</span> <span class="built_in">command</span>, e.g.:</span><br><span class="line"></span><br><span class="line">  alembic init --template generic ./scripts</span><br></pre></td></tr></table></figure>

<h3 id="3-配置"><a href="#3-配置" class="headerlink" title="3. 配置"></a>3. 配置</h3><p>使用之前，需要配置一下链接字符串，打开<code>alembic.ini</code>文件，设置<code>sqlalchemy.url</code>连接字符串，例如</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">sqlalchemy.url</span> = sqlite:////Users/zhengxiankai/Desktop/database.db</span><br></pre></td></tr></table></figure>

<p>其他参数可以参见官网说明：<a target="_blank" rel="noopener" href="http://alembic.zzzcomputing.com/en/latest/tutorial.html">http://alembic.zzzcomputing.com/en/latest/tutorial.html</a></p>
<h3 id="4-创建数据库版本"><a href="#4-创建数据库版本" class="headerlink" title="4. 创建数据库版本"></a>4. 创建数据库版本</h3><p>接下来我们创建一个数据库版本，并新建两个表</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ alembic revision -m <span class="string">&#x27;create table&#x27;</span></span><br></pre></td></tr></table></figure>
<p>创建一个版本（会在<code>yourproject/YOUR_ALEMBIC_DIR/versions/</code>文件夹中创建一个python文件<code>1a8a0d799b33_create_table.py</code>）</p>
<p>该python模块包含<code>upgrade</code>和<code>downgrade</code>两个方法，在这里添加一些新增表的逻辑</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;create table</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Revision ID: 4fd533a56b34</span></span><br><span class="line"><span class="string">Revises:</span></span><br><span class="line"><span class="string">Create Date: 2016-09-18 17:20:27.667100</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">from</span> alembic <span class="keyword">import</span> op</span><br><span class="line"><span class="keyword">import</span> sqlalchemy <span class="keyword">as</span> sa</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># revision identifiers, used by Alembic.</span></span><br><span class="line">revision = <span class="string">&#x27;4fd533a56b34&#x27;</span></span><br><span class="line">down_revision = <span class="literal">None</span></span><br><span class="line">branch_labels = <span class="literal">None</span></span><br><span class="line">depends_on = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">upgrade</span>():</span><br><span class="line">    <span class="comment"># 添加表</span></span><br><span class="line">    op.create_table(</span><br><span class="line">        <span class="string">&#x27;account&#x27;</span>,</span><br><span class="line">        sa.Column(<span class="string">&#x27;id&#x27;</span>, sa.Integer, primary_key=<span class="literal">True</span>),</span><br><span class="line">        sa.Column(<span class="string">&#x27;name&#x27;</span>, sa.String(<span class="number">50</span>), nullable=<span class="literal">False</span>),</span><br><span class="line">        sa.Column(<span class="string">&#x27;description&#x27;</span>, sa.Unicode(<span class="number">200</span>)),</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 添加列</span></span><br><span class="line">    <span class="comment"># op.add_column(&#x27;account&#x27;, sa.Column(&#x27;last_transaction_date&#x27;, sa.DateTime))</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">downgrade</span>():</span><br><span class="line">    <span class="comment"># 删除表</span></span><br><span class="line">    op.drop_table(<span class="string">&#x27;account&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 删除列</span></span><br><span class="line">    <span class="comment"># op.drop_column(&#x27;account&#x27;, &#x27;last_transaction_date&#x27;)</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里使用到了了op对象，关于op对象的更多API使用，参见<a target="_blank" rel="noopener" href="http://alembic.zzzcomputing.com/en/latest/ops.html#ops">这里</a></p>
<p>这里生成的文件名是依照在<code>alembic.ini</code>文件声明的模板来的，默认为版本号+名字，可以加上一些日期信息，否则不好排序，更多参数参见<a target="_blank" rel="noopener" href="http://alembic.zzzcomputing.com/en/latest/tutorial.html?highlight=file_template">这里</a></p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">file_template</span> = %%(year)d_%%(month).<span class="number">2</span>d_%%(day).<span class="number">2</span>d_%%(hour).<span class="number">2</span>d_%%(minute).<span class="number">2</span>d_%%(rev)s_%%(slug)s</span><br></pre></td></tr></table></figure>

<p>另外通常我们也改一下生成模板<code>script.py.mako</code>，加上编码信息，否则在升级脚本中如果有中文会报错</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br></pre></td></tr></table></figure>

<h3 id="5-升级数据库"><a href="#5-升级数据库" class="headerlink" title="5. 升级数据库"></a>5. 升级数据库</h3><p>刚刚实现了升级和降级的方法，通过下面命令升级数据库到最新版本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ alembic upgrade <span class="built_in">head</span></span><br></pre></td></tr></table></figure>
<p>这时候可以看到数据库多了两个表<code>alembic_version</code>和<code>account</code>，<code>alembic_version</code>存放数据库版本</p>
<p>关于升级和降级的其他命令还有下面这些</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 升到最高版本</span></span><br><span class="line">$ alembic upgrade <span class="built_in">head</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 降到最初版本</span></span><br><span class="line">$ alembic downgrade base</span><br><span class="line"></span><br><span class="line"><span class="comment"># 升两级</span></span><br><span class="line">$ alembic upgrade +2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 降一级</span></span><br><span class="line">$ alembic downgrade -1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 升级到制定版本</span></span><br><span class="line">$ alembic upgrade e93b8d488143</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看当前版本</span></span><br><span class="line">$ alembic current</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看历史版本详情</span></span><br><span class="line">$ alembic <span class="built_in">history</span> --verbose</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看历史版本（-r参数）类似切片</span></span><br><span class="line">$ alembic <span class="built_in">history</span> -r1975ea:ae1027</span><br><span class="line">$ alembic <span class="built_in">history</span> -r-3:current</span><br><span class="line">$ alembic <span class="built_in">history</span> -r1975ea:</span><br></pre></td></tr></table></figure>
<h3 id="6-通过元数据升级数据库"><a href="#6-通过元数据升级数据库" class="headerlink" title="6. 通过元数据升级数据库"></a>6. 通过元数据升级数据库</h3><p>上面我们是通过API升级和降级，我们也可以直接通过元数据更新数据库，也就是自动生成升级代码，先定义两个Model（<code>User</code>, <code>Role</code>），这里我定义成三个文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">yourproject/</span><br><span class="line">    YOUR_ALEMBIC_DIR/</span><br><span class="line">    tutorial/Db</span><br><span class="line">        Models.py</span><br><span class="line">        User.py</span><br><span class="line">        Role.py</span><br></pre></td></tr></table></figure>

<p>代码就放在一起了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy.ext.declarative <span class="keyword">import</span> declarative_base</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> Column, Integer, String</span><br><span class="line">Base = declarative_base()</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(<span class="title class_ inherited__">Base</span>):</span><br><span class="line">    __tablename__ = <span class="string">&#x27;users&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">id</span> = Column(<span class="string">&#x27;id&#x27;</span>, Integer, primary_key=<span class="literal">True</span>, autoincrement=<span class="literal">True</span>)</span><br><span class="line">    name = Column(<span class="string">&#x27;name&#x27;</span>, String)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Role</span>(<span class="title class_ inherited__">Base</span>):</span><br><span class="line">    __tablename__ = <span class="string">&#x27;roles&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">id</span> = Column(<span class="string">&#x27;id&#x27;</span>, Integer, primary_key=<span class="literal">True</span>, autoincrement=<span class="literal">True</span>)</span><br><span class="line">    name = Column(<span class="string">&#x27;name&#x27;</span>, String)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在<code>YOUR_ALEMBIC_DIR/env.py</code>配置元数据</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">target_metadata = <span class="literal">None</span></span><br></pre></td></tr></table></figure>

<p>改为</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这里需要添加相对路径到sys.path，否则会引用失败，尝试过使用相对路径，但各种不好使，还是使用这种方法靠谱些</span></span><br><span class="line">sys.path.append(os.path.abspath(os.path.join(os.getcwd(), <span class="string">&quot;../yourproject/tutorial/Db&quot;</span>)))</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> User <span class="keyword">import</span> User</span><br><span class="line"><span class="keyword">from</span> Role <span class="keyword">import</span> Role</span><br><span class="line"><span class="keyword">from</span> Models <span class="keyword">import</span> Base</span><br><span class="line">target_metadata = Base.metadata</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>os.path.join(os.getcwd()</code>这个获取到的地址不是env.py的路径，而是根目录</p>
</blockquote>
<p>在创建数据库版本的时候添加<code>--autogenerate</code>参数，就会从Base.metadata元数据中生成脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ alembic revision --autogenerate -m <span class="string">&quot;add user table&quot;</span></span><br></pre></td></tr></table></figure>

<p>这时候会在生成升级代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;add user table</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Revision ID: 97de1533584a</span></span><br><span class="line"><span class="string">Revises: 8678ab6d48c1</span></span><br><span class="line"><span class="string">Create Date: 2016-09-19 21:58:00.758410</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">from</span> alembic <span class="keyword">import</span> op</span><br><span class="line"><span class="keyword">import</span> sqlalchemy <span class="keyword">as</span> sa</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># revision identifiers, used by Alembic.</span></span><br><span class="line">revision = <span class="string">&#x27;97de1533584a&#x27;</span></span><br><span class="line">down_revision = <span class="string">&#x27;8678ab6d48c1&#x27;</span></span><br><span class="line">branch_labels = <span class="literal">None</span></span><br><span class="line">depends_on = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">upgrade</span>():</span><br><span class="line">    <span class="comment">### commands auto generated by Alembic - please adjust! ###</span></span><br><span class="line">    op.create_table(<span class="string">&#x27;roles&#x27;</span>,</span><br><span class="line">    sa.Column(<span class="string">&#x27;id&#x27;</span>, sa.Integer(), nullable=<span class="literal">False</span>),</span><br><span class="line">    sa.Column(<span class="string">&#x27;name&#x27;</span>, sa.String(), nullable=<span class="literal">True</span>),</span><br><span class="line">    sa.PrimaryKeyConstraint(<span class="string">&#x27;id&#x27;</span>)</span><br><span class="line">    )</span><br><span class="line">    op.create_table(<span class="string">&#x27;users&#x27;</span>,</span><br><span class="line">    sa.Column(<span class="string">&#x27;id&#x27;</span>, sa.Integer(), nullable=<span class="literal">False</span>),</span><br><span class="line">    sa.Column(<span class="string">&#x27;name&#x27;</span>, sa.String(), nullable=<span class="literal">True</span>),</span><br><span class="line">    sa.PrimaryKeyConstraint(<span class="string">&#x27;id&#x27;</span>)</span><br><span class="line">    )</span><br><span class="line">    op.drop_table(<span class="string">&#x27;account&#x27;</span>)</span><br><span class="line">    <span class="comment">### end Alembic commands ###</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">downgrade</span>():</span><br><span class="line">    <span class="comment">### commands auto generated by Alembic - please adjust! ###</span></span><br><span class="line">    op.create_table(<span class="string">&#x27;account&#x27;</span>,</span><br><span class="line">    sa.Column(<span class="string">&#x27;id&#x27;</span>, sa.INTEGER(), nullable=<span class="literal">False</span>),</span><br><span class="line">    sa.Column(<span class="string">&#x27;name&#x27;</span>, sa.VARCHAR(length=<span class="number">50</span>), nullable=<span class="literal">False</span>),</span><br><span class="line">    sa.Column(<span class="string">&#x27;description&#x27;</span>, sa.VARCHAR(length=<span class="number">200</span>), nullable=<span class="literal">True</span>),</span><br><span class="line">    sa.Column(<span class="string">&#x27;last_transaction_date&#x27;</span>, sa.DATETIME(), nullable=<span class="literal">True</span>),</span><br><span class="line">    sa.PrimaryKeyConstraint(<span class="string">&#x27;id&#x27;</span>)</span><br><span class="line">    )</span><br><span class="line">    op.drop_table(<span class="string">&#x27;users&#x27;</span>)</span><br><span class="line">    op.drop_table(<span class="string">&#x27;roles&#x27;</span>)</span><br><span class="line">    <span class="comment">### end Alembic commands ###</span></span><br></pre></td></tr></table></figure>
<p>由于我没有定义account模型，会被识别为删除，如果删除了model的列的声明，则会被识别为删除列，自动生成的版本我们也可以自己修改，然后执行升级命令即可升级<code>alembic upgrade head</code></p>
<p><strong>需要注意的是</strong></p>
<ol>
<li><code>Base.metadata</code>声明的类必须以数据库中的一一对应，如果数据库中有的表，而在元数据中没有，会识别成删除表</li>
<li>revision创建版本之前执行之前需要升级到最新版本</li>
<li>配置Base之前，需要保证所有的Model都已经执行（即导入）过一次了，否则无法读取到，也就是需要把所有Model都import进来</li>
</ol>
<blockquote>
<p>数据库升级有风险，升级前最好先检查一遍<code>upgrade</code>函数，可以的话做好备份哈</p>
</blockquote>
<h2 id="四、常见问题"><a href="#四、常见问题" class="headerlink" title="四、常见问题"></a>四、常见问题</h2><h3 id="1-String长度问题"><a href="#1-String长度问题" class="headerlink" title="1. String长度问题"></a>1. String长度问题</h3><p>如果使用mysql数据库，String类型对应的是VARCHAR类型，需要指定长度，否则会报下面错误，而在sqlite不会出现</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">in</span> table <span class="string">&#x27;user&#x27;</span>, column <span class="string">&#x27;name&#x27;</span>): VARCHAR requires a length on dialect mysql</span><br></pre></td></tr></table></figure>

<p>TODO：如有问题欢迎留言</p>
<h2 id="五、参考链接"><a href="#五、参考链接" class="headerlink" title="五、参考链接"></a>五、参考链接</h2><ul>
<li><a target="_blank" rel="noopener" href="http://alembic.zzzcomputing.com/en/latest/autogenerate.html">Auto Generating Migrations</a></li>
<li><a target="_blank" rel="noopener" href="http://alembic.zzzcomputing.com/en/latest/tutorial.html">tutorial</a></li>
</ul>

    </div>

    
    
    
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>Author
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://zhengbomo.github.io/2016-09-11/sqlalchemy-start/" title="sqlalchemy学习笔记">http://zhengbomo.github.io/2016-09-11/sqlalchemy-start/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/sql/" rel="tag"># sql</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2016-09-03/pycharm-jinja2/" rel="prev" title="pycharm添加jinja2模板引擎的识别">
      <i class="fa fa-chevron-left"></i> pycharm添加jinja2模板引擎的识别
    </a></div>
      <div class="post-nav-item">
    <a href="/2016-09-11/scrapy-start/" rel="next" title="scrapy学习笔记">
      scrapy学习笔记 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%E3%80%81%E5%AE%89%E8%A3%85"><span class="nav-number">1.</span> <span class="nav-text">一、安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C%E3%80%81%E4%BD%BF%E7%94%A8"><span class="nav-number">2.</span> <span class="nav-text">二、使用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-connection"><span class="nav-number">2.1.</span> <span class="nav-text">1. connection</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-connection%E4%BA%8B%E5%8A%A1"><span class="nav-number">2.2.</span> <span class="nav-text">2. connection事务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-session"><span class="nav-number">2.3.</span> <span class="nav-text">3. session</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-ORM"><span class="nav-number">2.4.</span> <span class="nav-text">4. ORM</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-%E5%A4%9A%E8%A1%A8%E5%85%B3%E7%B3%BB"><span class="nav-number">2.5.</span> <span class="nav-text">5. 多表关系</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-%E5%A4%9A%E8%A1%A8%E6%9F%A5%E8%AF%A2"><span class="nav-number">2.6.</span> <span class="nav-text">6. 多表查询</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89%E3%80%81%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%81%E7%A7%BB"><span class="nav-number">3.</span> <span class="nav-text">三、数据库迁移</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%AE%89%E8%A3%85"><span class="nav-number">3.1.</span> <span class="nav-text">1. 安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-number">3.2.</span> <span class="nav-text">2. 初始化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E9%85%8D%E7%BD%AE"><span class="nav-number">3.3.</span> <span class="nav-text">3. 配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE%E5%BA%93%E7%89%88%E6%9C%AC"><span class="nav-number">3.4.</span> <span class="nav-text">4. 创建数据库版本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-%E5%8D%87%E7%BA%A7%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="nav-number">3.5.</span> <span class="nav-text">5. 升级数据库</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-%E9%80%9A%E8%BF%87%E5%85%83%E6%95%B0%E6%8D%AE%E5%8D%87%E7%BA%A7%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="nav-number">3.6.</span> <span class="nav-text">6. 通过元数据升级数据库</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9B%9B%E3%80%81%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98"><span class="nav-number">4.</span> <span class="nav-text">四、常见问题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-String%E9%95%BF%E5%BA%A6%E9%97%AE%E9%A2%98"><span class="nav-number">4.1.</span> <span class="nav-text">1. String长度问题</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%94%E3%80%81%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5"><span class="nav-number">5.</span> <span class="nav-text">五、参考链接</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Author"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">Author</p>
  <div class="site-description" itemprop="description">懒人</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">99</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">45</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/zhengbomo" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;zhengbomo" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:zhengbomo@hotmail.com" title="Email → mailto:zhengbomo@hotmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>Email</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/intent/user?user_id=371531868" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;intent&#x2F;user?user_id&#x3D;371531868" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
      <span class="links-of-author-item">
        <a href="http://facebook.com/zhengbomo" title="Facebook → http:&#x2F;&#x2F;facebook.com&#x2F;zhengbomo" rel="noopener" target="_blank"><i class="fab fa-facebook fa-fw"></i>Facebook</a>
      </span>
      <span class="links-of-author-item">
        <a href="tencent://message/?uin=449179249&Site=&Menu=yes" title="QQ → tencent:&#x2F;&#x2F;message&#x2F;?uin&#x3D;449179249&amp;Site&#x3D;&amp;Menu&#x3D;yes" rel="noopener" target="_blank"><i class="fab fa-qq fa-fw"></i>QQ</a>
      </span>
      <span class="links-of-author-item">
        <a href="http://weibo.com/1891587992" title="Weibo → http:&#x2F;&#x2F;weibo.com&#x2F;1891587992" rel="noopener" target="_blank"><i class="fab fa-weibo fa-fw"></i>Weibo</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2016 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">bomo</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
